
# Universal NUT UPS Template for Zabbix 7.x

![Zabbix](https://img.shields.io/badge/Zabbix-7.0%2B-red) ![License](https://img.shields.io/badge/License-GPLv3-blue)

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –±–µ—Å–ø–µ—Ä–µ–±–æ–π–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è (–ò–ë–ü) —á–µ—Ä–µ–∑ **Network UPS Tools (NUT)** –≤ —Å–∏—Å—Ç–µ–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ **Zabbix 7.0+**.

–®–∞–±–ª–æ–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è **APC Smart-UPS**, –Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ò–ë–ü, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö NUT. –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å "–º—É—Å–æ—Ä–Ω—ã–º" –≤—ã–≤–æ–¥–æ–º –∫–æ–Ω—Å–æ–ª–∏ (`Init SSL without certificate database`), –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç JSON Discovery –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

## üìä –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

–®–∞–±–ª–æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏ —Å–æ–±–∏—Ä–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏:

* **–ë–∞—Ç–∞—Ä–µ—è:**
    * –£—Ä–æ–≤–µ–Ω—å –∑–∞—Ä—è–¥–∞ (%)
    * –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ (V)
    * –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)
    * **Runtime** (–û—Å—Ç–∞—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö/–º–∏–Ω—É—Ç–∞—Ö)
    * –°—Ç–∞—Ç—É—Å (–ó–∞—Ä—è–¥–∫–∞, –†–∞–∑—Ä—è–¥–∫–∞, –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–º–µ–Ω–∞ –∏ —Ç.–¥.)
* **–í—Ö–æ–¥ / –í—ã—Ö–æ–¥:**
    * –í—Ö–æ–¥—è—â–µ–µ/–ò—Å—Ö–æ–¥—è—â–µ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ (V)
    * –ß–∞—Å—Ç–æ—Ç–∞ (Hz)
    * –°–∏–ª–∞ —Ç–æ–∫–∞ (A)
* **–ù–∞–≥—Ä—É–∑–∫–∞:**
    * –¢–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ò–ë–ü (%)
* **–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è:**
    * –ú–æ–¥–µ–ª—å, –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä, –î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –±–∞—Ç–∞—Ä–µ–∏.

## üõ†Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1.  Zabbix Server 7.0 –∏–ª–∏ –≤—ã—à–µ.
2.  Zabbix Agent (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –º–∞—à–∏–Ω–µ, –≥–¥–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –ò–ë–ü).
3.  –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–∞–∫–µ—Ç `nut-server` –∏ `nut-client` (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π `upsc -L`).

## ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (Linux)

–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã Discovery –∏ –æ—á–∏—Å—Ç–∫–∏ –≤—ã–≤–æ–¥–∞ –æ—Ç SSL-–æ—à–∏–±–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π wrapper-—Å–∫—Ä–∏–ø—Ç.

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ —Ö–æ—Å—Ç–µ —Å –ò–ë–ü:

```bash
sudo nano /etc/zabbix/scripts/ups_handler.sh

```

–í—Å—Ç–∞–≤—å—Ç–µ –≤ –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```bash
#!/bin/bash

# IP –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ NUT (–æ–±—ã—á–Ω–æ localhost –∏–ª–∏ IP —Å–µ—Ä–≤–µ—Ä–∞)
NUT_HOST="127.0.0.1" 
# –ï—Å–ª–∏ NUT —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: username:password@127.0.0.1

# --- –†–ï–ñ–ò–ú 1: –ê–≤—Ç–æ–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ (Discovery) ---
if [ "$1" = "ups.discovery" ]; then
    /usr/bin/upsc -L $NUT_HOST 2>/dev/null | sed 's/://' | awk 'BEGIN {printf "{\"data\":["} {printf "{\"{#UPSNAME}\":\""$1"\"},"} END {print "]}"}' | sed 's/,]}/]}/'
    exit 0
fi

# --- –†–ï–ñ–ò–ú 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ ---
if [ -z "$3" ]; then
    # –í–∞—Ä–∏–∞–Ω—Ç: –ü—Ä–∏—à–ª–æ 2 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–ò–º—è, –ú–µ—Ç—Ä–∏–∫–∞)
    UPS_NAME=$1
    METRIC=$2
    TARGET_HOST=$NUT_HOST
else
    # –í–∞—Ä–∏–∞–Ω—Ç: –ü—Ä–∏—à–ª–æ 3 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–ò–º—è, IP, –ú–µ—Ç—Ä–∏–∫–∞) - –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    UPS_NAME=$1
    TARGET_HOST=$2
    METRIC=$3
fi

# –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å, –ø–æ–¥–∞–≤–ª—è—è –æ—à–∏–±–∫–∏ SSL
/usr/bin/upsc "${UPS_NAME}@${TARGET_HOST}" "$METRIC" 2>/dev/null

```

> **–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ –≤–∞—à NUT —Å–ª—É—à–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π IP, –∏–∑–º–µ–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `NUT_HOST` –≤–Ω—É—Ç—Ä–∏ —Å–∫—Ä–∏–ø—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ `192.168.1.10`).

–î–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:

```bash
sudo chmod +x /etc/zabbix/scripts/ups_handler.sh

```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Zabbix Agent

–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∞–≥–µ–Ω—Ç–∞ (–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –≤ `/etc/zabbix/zabbix_agentd.d/nut.conf`):

```bash
sudo nano /etc/zabbix/zabbix_agentd.conf

```

–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ —Å—Ç—Ä–æ–∫—É **UserParameter**:

```ini
UserParameter=upsmon[*],/etc/zabbix/scripts/ups_handler.sh "$1" "$2" "$3"

```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞:

```bash
sudo systemctl restart zabbix-agent

```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã (–¢–µ—Å—Ç)

–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å–∫—Ä–∏–ø—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ Zabbix –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ `zabbix_get`:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è (–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —á–∏—Å—Ç—ã–π JSON)
zabbix_get -s 127.0.0.1 -k upsmon[ups.discovery]

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–∑–∞–º–µ–Ω–∏—Ç–µ 'apc' –Ω–∞ –∏–º—è –≤–∞—à–µ–≥–æ –ò–ë–ü)
zabbix_get -s 127.0.0.1 -k upsmon[apc,battery.charge]

```

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ Zabbix (Web Interface)

1. –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª `zabbix_nut_universal_ru.xml` –∏–∑ —ç—Ç–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Zabbix: **Data collection** -> **Templates**.
3. –ù–∞–∂–º–∏—Ç–µ **Import** (—Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É).
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –∏ –Ω–∞–∂–º–∏—Ç–µ **Import**.
5. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ö–æ—Å—Ç–∞ (**Hosts**), –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø–æ–¥–∫–ª—é—á–µ–Ω –ò–ë–ü.
6. –î–æ–±–∞–≤—å—Ç–µ —à–∞–±–ª–æ–Ω **NUT UPS Universal RU**.
7. –ß–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã (–∏–ª–∏ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "Execute now" –≤ Discovery rules) –ø–æ—è–≤—è—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏.

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π **GPL v3**.
–í—ã –º–æ–∂–µ—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω.

–ê–≤—Ç–æ—Ä: [didimozg](https://github.com/didimozg)
